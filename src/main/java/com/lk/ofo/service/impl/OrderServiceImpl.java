package com.lk.ofo.service.impl;

import com.lk.ofo.dao.BicycleDao;
import com.lk.ofo.dao.OrderDao;
import com.lk.ofo.dao.UserDao;
import com.lk.ofo.entity.*;
import com.lk.ofo.entity.param.OrderParam;
import com.lk.ofo.entity.vo.OrderGraphVO;
import com.lk.ofo.enums.ConstantEnum;
import com.lk.ofo.exception.ServiceException;
import com.lk.ofo.service.OrderService;
import com.lk.ofo.util.DateUtil;
import org.apache.commons.lang3.ArrayUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;

import static com.lk.ofo.util.DateUtil.getMonthNumber;
import static com.lk.ofo.util.DateUtil.getWeekday;

@Service
public class OrderServiceImpl implements OrderService {

    @Autowired
    private OrderDao orderDao;

    @Autowired
    private BicycleDao bicycleDao;

    @Autowired
    private UserDao userDao;

    @Override
    public Page<Order> getOrderList(Integer offset, Integer limit, OrderParam param) {
        Page<Order> page = new Page<Order>();
        page.setCurrentIndex(offset);
        page.setPageSize(limit);
        String sql = param.createQueryParam();
        page.setTotalNumber(orderDao.getCount(sql));
        List list = orderDao.queryAllOrder((offset - 1) * limit, limit, sql);
        page.setItems(list);
        return page;
    }

    @Override
    public Order getOrder(Integer id) {
        return orderDao.queryOrderById(id);
    }

    /**
     * 查询最近此自行车未完成的结果
     */
    @Override
    public Order getOrder2(Integer bicycleId) {
        Order order = getOrder(bicycleId);
        return null;
    }

    @Transactional
    @Override
    public Order createOrder(Integer userId, Integer bicycleId, String s_x, String s_y) throws ServiceException {
        //看车辆结束没,结束订单
        Bicycle bicycle = bicycleDao.queryBicycleById(bicycleId);
        //正在使用
        if (bicycle.getStatus().equals(ConstantEnum.BICYCLE_USING)) {
            bicycle.setStatus(ConstantEnum.BICYCLE_READY);
            //结束订单
        }//正在故障中
        else if (bicycle.getStatus().equals(ConstantEnum.BICYCLE_WORING)) {
            throw new ServiceException("自行车故障中");
        }

        bicycle.setStatus(ConstantEnum.BICYCLE_USING);
        bicycle.setAddressX(Double.parseDouble(s_x));
        bicycle.setAddressY(Double.parseDouble(s_y));
        bicycleDao.updateBicycle(bicycle);
        //产生订单
        Order order = new Order();
        order.setBicycleId(bicycleId);
        order.setUserId(userId);
        order.setStartTime(new Date());
        order.setStart_X(s_x);
        order.setStart_Y(s_y);
        order.setStatus(ConstantEnum.ORDER_NOT_COMPLETE);
        orderDao.add(order);
        return order;
    }

    @Transactional
    @Override
    public Boolean endOrder(Integer orderId, Integer userId, Integer bicycleId, String x, String y) {
        Order order = orderDao.queryOrderById(orderId);
        if (order == null) {
            throw new ServiceException("不存在此订单");
        }
        //未完成
        if (!ConstantEnum.ORDER_NOT_COMPLETE.equals(order.getStatus())) {
            throw new ServiceException("订单状态错误");
        }
        //改变车辆位置
        Bicycle bicycle = bicycleDao.queryBicycleById(bicycleId);
        bicycle.setStatus(ConstantEnum.BICYCLE_READY);
        bicycle.setAddressX(Double.parseDouble(x));
        bicycle.setAddressY(Double.parseDouble(y));
        bicycleDao.updateBicycle(bicycle);
        //改变订单状态
        order.setEnd_X(x);
        order.setEnd_Y(y);
        order.setStatus(ConstantEnum.ORDER_NOT_PAY);
        order.setEndTime(new Date());
        order.setUpdateTime(new Date());
        //计算价格
        order.setCost(DateUtil.dateSubtractOfMin(order.getStartTime(), order.getEndTime()) * ConstantEnum.PRICE);
        return orderDao.update(order);
    }

    @Override
    public Boolean payment(Integer orderId, Integer userId) {//付款
        Order order = orderDao.queryOrderById(orderId);
        if (order == null) {
            throw new ServiceException("不存在此订单");
        }
        //未完成
        if (!ConstantEnum.ORDER_NOT_PAY.equals(order.getStatus())) {
            throw new ServiceException("订单状态错误");
        }

        User user = userDao.queryUserById(userId);
        int userId1 = order.getUserId();
        if (user == null || userId != userId1) {
            throw new ServiceException("用户信息错误");
        }
        //改变状态
        order.setStatus(ConstantEnum.ORDER_COMPLETE);
        order.setUpdateTime(new Date());
        return orderDao.update(order);
    }

    @Override
    public OrderGraphVO graph1() {
        OrderGraphVO graphVO = new OrderGraphVO();
        int count = orderDao.getCount("1=1");
        //不同星期的数据
        List<Order> orders = orderDao.queryAllOrder(0, count, "1=1");
        int[] list = new int[7];
        for (Order order : orders) {
            Date date = order.getStartTime();
            //获取天使
            Integer i = getWeekday(date);
            list[i] = ++list[i];
        }
        graphVO.setWeek(Arrays.asList(ArrayUtils.toObject(list)));

        //所有价格的函数
        List<Double> money = new ArrayList<>(count);
        for (Order order : orders) {
            if (ConstantEnum.ORDER_COMPLETE.equals(order.getStatus())) {
                money.add(order.getCost());
            }
        }
        graphVO.setMonney(money);

        //获取12个月不同的类型
        int[] months = new int[12];
        for (Order order : orders) {
            Date date = order.getCreateTime();
            int month = getMonthNumber(date);
            months[month] = ++months[month];
        }
        graphVO.setMonths(Arrays.asList(ArrayUtils.toObject(months)));
        //获取不同状态的自行车
        int[] bicycles = new int[3];
        List<Bicycle> bicycleList = bicycleDao.queryAllBicycle(0, bicycleDao.getCount());
        for (Bicycle bicycle : bicycleList) {
            if (bicycle.getStatus().equals(ConstantEnum.BICYCLE_USING)) {
                bicycles[0] = bicycles[0] + 1;
            } else if (bicycle.getStatus().equals(ConstantEnum.BICYCLE_WORING)) {
                bicycles[1] = bicycles[1] + 1;
            } else if (bicycle.getStatus().equals(ConstantEnum.BICYCLE_READY)) {
                bicycles[2] = bicycles[2] + 1;
            }
        }
        graphVO.setBicycles(Arrays.asList(ArrayUtils.toObject(bicycles)));
        //图表5
        graphVO.setdBicycle(graph5());
        return graphVO;
    }

    private Map graph5() {
        Map<String, Object> dBicycles = new HashMap<>(3);
        List<String> list1 = new LinkedList<>();
        List<int[]> list2 = new LinkedList<>();
        List<Integer> list3 = new LinkedList<>();
        //先取出损坏的车辆
        List<DestroyBicycle> destroyBicycles = bicycleDao.getDestroyBicycleList();
        Integer index = 0;
        for (DestroyBicycle destroyBicycle : destroyBicycles) {
            //保存损坏
            list1.add(destroyBicycle.getId() + "");
            list3.add(index);
            int temp=index++;
            List<Order> orders = orderDao.queryOrderByBicycle(destroyBicycle.getId());
            for (Order order : orders) {
                String id = order.getUserId() + "";
                int index_user;
                if(list1.contains(id)){
                    index_user=list1.indexOf(id);
                }else{
                    list1.add(id);
                    index_user=index++;
                }
                int[] temp2=new int[]{temp,index_user};
                boolean flag=true;
                int i;
                for(i=0;i<list2.size();i++){
                    int[] a=list2.get(i);
                    if(!t_equals(a,temp2)){
                        break;
                    }
                }
                if(i>=list2.size()){
                    list2.add(temp2);
                }
            }
        }
        dBicycles.put("1",list1);
        dBicycles.put("2",list2);
        dBicycles.put("3",list3);
        return dBicycles;
    }

    private boolean t_equals(int[] a,int[] b){
        if(a[0]!=b[0])
            return true;
        if(a[1]!=b[1])
            return true;
        return false;
    }


    @Override
    public Integer getCount() {
        return orderDao.getCount("1=1");
    }


}
